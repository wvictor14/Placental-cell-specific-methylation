---
title: "2_7_PMDs"
author: "Victor Yuan"
date: "23/09/2019"
output:
  html_document:
    keep_md: true
    toc: true
    toc_depth: 4
    toc_float:
      collapsed: false
    theme: spacelab
editor_options: 
  chunk_output_type: console
---


# Setup

## Libraries


```{r, message = FALSE, warning = FALSE}
# libraries and data
library(tidyverse); theme_set(theme_bw())
library(DT)
```

## Data

```{r, message = FALSE, warning = FALS}
pDat <- readRDS('../../data/main/interim/2_3_pDat_contam.rds')
pDat <- pDat %>%
  mutate(Tissue = case_when(
    !(Tissue %in% c('Villi', 'Villi maternal', 'Syncytiotrophoblast')) ~ paste(Tissue, 'cs'),
    Tissue == 'Syncytiotrophoblast' ~ 'Trophoblasts enz',
    TRUE ~ Tissue
  )) 

# raw methylation data
betas <- readRDS('../../data/main/interim/1_4_betas_noob_filt.rds')

mset_noob <- readRDS('../../data/main/interim/1_4_mset_noob.rds') # for mvals
colnames(mset_noob) <- colnames(betas) <- pDat$Sample_Name
mvals <- getM(mset_noob)

probe_anno <- readRDS('../../data/main/interim/1_1_probe_anno.rds')

# color key
pheatmap_color_code <- readRDS('../../data/main/interim/1_1_color_code.rds')

color_code <- readRDS('../../data/main/interim/2_3_color_code.rds')
color_code_tissue <- setNames(color_code$Colors_Tissue, color_code$label)

# DMCs
dmcs <- readRDS('../../data/main/interim/2_4_dmcs.rds')

# annotation
anno <- readRDS('Z:/Victor/Repositories/EPIC_annotation/hg19_epic_annotation.rds')

#color code
color_code <- readRDS('../../data/main/interim/2_3_color_code.rds')
color_code_tissue <- setNames(color_code$Colors_Tissue, color_code$label)

# 450k annotation
anno_450k <- read_csv('Z:/Victor/Data/DNAm annotations/HumanMethylation450_15017482_v1-2.csv',
                      skip = 7)
```

## Remove samples

remove contamined and non-interesting samples

```{r}
pDat_filt <- pDat %>% 
  filter(maternal_contamination_norm_flip < 0.35,
         !Sample_Name %in% c('PM364_hofb_cs', 'PL293_v_R2', 'PM366_vc_R2', 'P131_hofb_cs'),
         !Tissue %in% c('Villi maternal', 'Trophoblasts enz', 'Mixture cs', 'Dead Cells and Lymphocytes cs'))

# filter to first trimester
mvals_filt <- mvals[rownames(betas),pDat_filt$Sample_Name]
betas_filt <- betas[,pDat_filt$Sample_Name]
```

# PMD

## Filter cpgs

D.I schroeder state that they remove probes in  the following regions:

* promoters
* cpg islands
* cpg island shores


```{r}
# find cpgs in pmds and meeting above criteria
anno_pmd_filt <- anno %>%
  filter(!cpg_id %in% c('island', 'shore'),
         !grepl('promoter', genes_id),
         !is.na(pmd_id))
nrow(anno); nrow(anno_pmd_filt) # 867052; 133370

pmd_cpgs_epic <- intersect(anno_pmd_filt$cpg, rownames(betas_filt)) # 111378
pmd_cpgs_450k <- intersect(anno_450k$IlmnID, pmd_cpgs_epic)

length(pmd_cpgs_epic);length(pmd_cpgs_450k) # 111378;39142
```

## Calculate densities

Now I can calculate the density per celltype / trimeseter. I follow the same code from my enrichment
analysis.

```{r}
densities <- pDat_filt %>%
  
  # get sample names for each group
  select(Trimester, Tissue, Sample_Name) %>%
  dplyr::rename(Celltype = Tissue) %>%
  group_by(Trimester, Celltype) %>%
  summarize(Samples =list(Sample_Name)) %>%
  
  # duplicate rows
  mutate(array = 'EPIC') %>%
  ungroup() %>%
  bind_rows( identity(.) %>% mutate(array = '450k')) %>%
  
  # Calculate densities
  mutate(densities = case_when(
    array == 'EPIC' ~ map(Samples, ~as.vector(betas_filt[pmd_cpgs_epic, .x]) %>% density()),
    array == '450k' ~map(Samples, ~as.vector(betas_filt[pmd_cpgs_450k, .x]) %>% density())
    ),
         x = map(densities, 'x'),
         y = map(densities, 'y')) %>%
     
 # clean up results
 # remove input data
  select(Trimester, Celltype, contains('x'), contains('y')) %>%
  unnest()
```

## Plot

density plots

```{r}
### EPIC
densities %>% 
  filter(array == 'EPIC') %>%
  ggplot(data = .) +
  geom_line(size = 2,aes(x = x, y = y, color = Celltype)) + theme_bw() +
  scale_x_continuous(breaks = c(0, 0.25, 0.5, 0.75, 1)) +
  facet_grid(Trimester~Celltype) +
  scale_color_manual(values= color_code_tissue[unique(densities$Celltype)]) +
  labs(x = '% methylation', y = 'density', color = '', title = 'EPIC')

### 450k
densities %>% 
  filter(array == '450k') %>%
  ggplot(data = .) +
  geom_line(size = 2,aes(x = x, y = y, color = Celltype)) + theme_bw() +
  scale_x_continuous(breaks = c(0, 0.25, 0.5, 0.75, 1)) +
  facet_grid(Trimester~Celltype) +
  scale_color_manual(values= color_code_tissue[unique(densities$Celltype)]) +
  labs(x = '% methylation', y = 'density', color = '', title = '450k')
```

Let's look at a few specific PMDs

subset to those with a lot of cpg coverage

```{r}
# manually explore regions to plot
anno %>%
  
  filter(cpg %in% rownames(betas_filt)) %>%
  
  # count number of cpgs per pmd, parse the pmd_id into position
  group_by(pmd_id) %>%
  summarize(n = n(), pmd_width = paste(unique(pmd_width), collapse = ', ')) %>%
  filter(!is.na(pmd_id)) %>%
  separate(pmd_id, into = c('chr', 'start', 'end')) %>%
  mutate(chr = factor(chr, levels = paste0('chr', c(1:22, 'X'))),
         start = as.numeric(start),
         end = as.numeric(end)) %>%
  arrange(chr, start) %>%
  
  # filter out pmds with low coverage
  filter(n > 20) %>%
  datatable()

# define plotting function
plot_region <- function(c, s, e, span = 0.1, cpg_size = 500,
                        filtered = TRUE, array = 'EPIC') {
  
  if (filtered) {
    region1 <- anno %>%
      filter(chr == c, between(start, s, e),
             cpg %in% rownames(betas_filt),
             !cpg_id %in% c('island', 'shore'),
             !grepl('promoter', genes_id)) %>%
      pull(cpg)
  } else {
    region1 <- anno %>%
      filter(chr == c, between(start, s, e),
             cpg %in% rownames(betas_filt)) %>%
      pull(cpg)
  }
  
  if (array == '450K') {
    region1 <- intersect(anno_450k$Name, region1)
  } 
  
  # subset to cpgs in region
  region1_data <- betas_filt[region1, ] %>%
    
    t() %>%
    as.data.frame() %>%
    bind_cols(Sample_Name = rownames(.), .) %>%
    
    # melt
    gather(cpg, beta, -Sample_Name) %>%
    
    # add trimester and sex
    inner_join(pDat_filt %>% select(Sample_Name, Trimester, Tissue)) %>%
    
    # add cpg coordinates
    inner_join(anno %>% select(cpg, chr, pos = start)) %>%
    
    # set a grouping variable to control alpha for placenta/troph
    mutate(alpha_group = if_else(Tissue %in% c('Trophoblasts cs', 'Villi'),
                                 1, 0.6)) %>%
    
    # remove second trimester data
    filter(Trimester != 'Second')
  
  # get pmd data
  pmd_data <- anno %>%
    filter(chr == c, between(start, s, e), 
           !is.na(pmd_id)) %>%
    select(pmd_id) %>%
    separate(pmd_id, into = c('chr', 'start', 'end'), remove = FALSE) %>%
    mutate(chr = factor(chr, levels = paste0('chr', c(1:22, 'X'))),
           start = as.numeric(start),
           end = as.numeric(end)) %>%
    arrange(chr, start) %>%
    distinct()
  
  ggplot(region1_data) +
    geom_line(stat = 'smooth', span = span, method = 'loess', se = FALSE,
              aes(x = pos, y = beta, color = Tissue, alpha = alpha_group), size = 1.25) +
    geom_rect(data = pmd_data, 
              aes(xmin = start, xmax = end), 
              ymin = 0.025, ymax = 0.05, fill = 'black') +
    geom_rect(aes(xmin = pos - cpg_size/2, xmax = pos + cpg_size/2), 
              ymin = 0, ymax = 0.025, fill = 'red') +
    facet_wrap(~Trimester, ncol = 1) +
    scale_color_manual(values= color_code_tissue[unique(region1_data$Tissue)]) +
    scale_y_continuous(limits = c(0, 1.1), breaks = c(0, 0.25, 0.5, 0.75, 1)) +
    scale_x_continuous(limits = c(s, e)) +
    scale_alpha_identity() +
    labs(x = paste0(c, ':', s, '-', e))
}
```

plot regions

```{r warning = FALSE, message = FALSE}
plot_region(c = 'chr1', s = 1000000, e = 1130000, span = 0.25,filtered = T) 
plot_region(c = 'chr1', s = 1000000, e = 1130000, span = 0.25, filtered = F) 

plot_region(c = 'chr4', s = 6400000, e = 6600000, span = 0.15, filtered = T)
plot_region(c = 'chr4', s = 6400000, e = 6600000, span = 0.15, filtered = F) 

plot_region(c = 'chr7', s = 850000, e = 1025000, span = 0.15, filtered = T)
plot_region(c = 'chr7', s = 850000, e = 1025000, span = 0.15, filtered = F) 

# Figure 1d
plot_region(c = 'chr21', s = 28000000, e = 45000000, span = 0.05, filtered = T, cpg_size = 5000,
            array = '450k')
plot_region(c = 'chr21', s = 28000000, e = 45000000, span = 0.05, filtered = T, cpg_size = 5000) 
plot_region(c = 'chr21', s = 28000000, e = 45000000, span = 0.15, filtered = F, cpg_size = 5000) 
```
