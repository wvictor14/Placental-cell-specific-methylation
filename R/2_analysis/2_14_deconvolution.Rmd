---
title: "2_14_deconvolution"
author: "Victor Yuan"
date: "16/01/2020"
output:
  html_document:
    keep_md: true
    toc: true
    toc_depth: 4
    toc_float:
      collapsed: false
    theme: spacelab
    highlight: tango 
editor_options: 
  chunk_output_type: console
---
# Setup

## Libraries

```{r, message = FALSE, warning = FALSE}
# libraries and data
library(tidyverse)
library(scales)
library(here)
library(readxl)
library(janitor)
library(minfi)
library(broom)
library(pheatmap)
theme_set(theme_bw())
library(EpiDISH)
library(yardstick)
library(ggbeeswarm)
library(planet)
```

## Data

```{r eval = TRUE}
base_path <- file.path('data', 'main', 'interim')

# pData
pDat <- readRDS(here(base_path, '2_3_pDat_contam.rds'))
pDat <- pDat %>%
  mutate(Tissue = case_when(
    !(Tissue %in% c('Villi', 'Villi maternal', 'Syncytiotrophoblast', 'Mixture')) ~ paste(Tissue, 'cs'),
    Tissue == 'Syncytiotrophoblast' ~ 'Trophoblasts enz',
    TRUE ~ Tissue
  )) 

# raw methylation data
betas <- readRDS(here(base_path, '1_4_betas_noob_filt.rds'))
mset <- readRDS(here(base_path, '1_4_mset_noob.rds' ))
colnames(mset) <- pData(mset)$Sample_Name

# annotation
anno <- readRDS('Z:/Victor/Repositories/EPIC_annotation/hg19_epic_annotation.rds')
anno <- anno %>%
  as_tibble() %>%
  filter(cpg %in% rownames(betas)) # filter to filtered betas cpgs

# cell proportions for mixtures
mixtures <- read_excel(here::here('data', 'main', 'raw', 'Mixtures.xlsx'))

# color key
color_code <- readRDS(here(base_path, '2_3_color_code.rds'))
color_code_tissue <- setNames(color_code$Colors_Tissue, gsub(' cs', '',color_code$label))

color_code_tissue <- c(color_code_tissue, 'nRBC' = 'grey')

# ancestry information
ancestry <- readRDS(here(base_path, '2_11_ancestry.rds'))
```

## Remove samples

```{r}
pDat_filt <- pDat %>% 
  filter(maternal_contamination_norm_flip < 0.35,
         !Sample_Name %in% c('PM364_hofb_cs', 'PL293_v_R2', 'PM366_vc_R2', 'P131_hofb_cs', 
                             'PM324_V4', 'PM324_V1', 'PM139_vc', 'PM77_vc'),
         !Tissue %in% c('Villi maternal', 
                        'Trophoblasts enz',
                        'Dead Cells and Lymphocytes cs'),
         Trimester != 'Second')

betas_filt <- betas[,pDat_filt$Sentrix]
colnames(betas_filt) <- pDat_filt$Sample_Name
```

# get nRBC data

Meg's recent publciation provides a curated reference for cord blood data: https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6712867/#CR22
"Systematic evaluation and validation of reference and library selection methods for deconvolution of cord blood DNA methylation data"

https://bioconductor.org/packages/release/data/experiment/vignettes/FlowSorted.CordBloodCombined.450k/inst/doc/FlowSorted.CordBloodCombined.450k.html

Note this is a 450k dataset
```{r, eval = FALSE}
if (memory.limit()>8000){
library(ExperimentHub)  

hub <- ExperimentHub()  

myfiles <- query(hub, "FlowSorted.CordBloodCombined.450k")

FlowSorted.CordBloodCombined.450k <- myfiles[[1]]

FlowSorted.CordBloodCombined.450k
}

# subset to nrbc
nrbc <- FlowSorted.CordBloodCombined.450k[,pData(FlowSorted.CordBloodCombined.450k)$CellType == 'nRBC']

pData(nrbc)
nrbc_noob <- preprocessNoob(nrbc)


nrbc_pDat <- pData(nrbc_noob) %>%
  as_tibble() %>%
  dplyr::rename(Tissue = CellType) %>%
  mutate(Trimester = 'Third') %>%
  select(Sample_Name, Tissue, Trimester, Sex, Study) 
  
pData(nrbc_noob) <- DataFrame(nrbc_pDat)

saveRDS(nrbc_noob, here::here(base_path, '2_14_nrbc_noob.rds'))
```


# Houseman Deconvolution

I apply to first and third trimester samples separately, each with their own trimester-specific reference.

```{r}
# filter to project samples
mset_filt <- mset[,pDat_filt$Sample_Name]
pData(mset_filt) <- DataFrame(pDat_filt)

# necessary column for pickcompprobes
mset$CellType <- mset$Tissue

mset_ref <- mset[,pData(mset)$Tissue %in% c('Trophoblasts', 'Stromal', 'Hofbauer', 'Endothelial')]
mset_test <- mset[,pData(mset)$Tissue %in% c('Mixture', 'Villi')]

# pick probes
probes_third <- minfi:::pickCompProbes(
  mset_ref[, pData(mset_ref)$Trimester == 'Third'], 
  cellTypes = c('Trophoblasts', 'Stromal', 'Hofbauer', 'Endothelial'),
  compositeCellType = 'Placenta',
  probeSelect = "both")

probes_first <- minfi:::pickCompProbes(
  mset_ref[, pData(mset_ref)$Trimester == 'First'], 
  cellTypes = c('Trophoblasts', 'Stromal', 'Hofbauer', 'Endothelial'),
  compositeCellType = 'Placenta',
  probeSelect = "both")


# extract coefficients
coefs_third <- probes_third$coefEsts
coefs_first <- probes_first$coefEsts

# project 
counts_third <- minfi:::projectCellType(
  getBeta(mset_test)[rownames(coefs_third),pData(mset_test)$Trimester == 'Third'], 
  coefs_third,
  lessThanOne = FALSE)

counts_first<- minfi:::projectCellType(
  getBeta(mset_test)[rownames(coefs_first),pData(mset_test)$Trimester == 'First'], 
  coefs_first,
  lessThanOne = FALSE)

res <- rbind(counts_third, counts_first) %>%
  as.data.frame() %>%
  bind_cols(Sample_Name = rownames(.), .) %>%
  inner_join(pData(mset_test) %>% as_tibble());res

# plot
res %>%
  select(Tissue, Sample_Name:Endothelial)  %>%
  pivot_longer(cols = -c(Tissue, Sample_Name),
               names_to = 'Estimates',
               values_to = 'p') %>%
  ggplot(aes(x = Sample_Name, y = p, fill = Estimates)) +
  geom_bar(stat = 'identity', position = 'stack') +
  facet_grid(cols = vars(Tissue), scales = 'free', space = 'free') +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank()) +
  scale_y_continuous(expand = c(0,0))

```


# Compare accuracy

Mixture 13 replaces mixture 4 due to failed BSC conversion

Mixture 4 replaces mixture 8 due to failed BSC conversion
Mixture 14 replaces mixture 7 ^ ^ ^ ^
Mixture 7 replaces mixture 5 due to loss of DNA during mixing

```{r}
mixtures_results <- mixtures %>% select(Sample, Case_ID, contains('%')) %>%
  janitor::clean_names() %>%
  pivot_longer(cols = -c(sample, case_id),
               names_to = 'component',
               values_to = 'actual_percent') %>%
  mutate(component = gsub('_percent', '', component))  %>%
  dplyr::rename(Sample_Name = sample) %>%
  filter(component !='total') %>%
  mutate(Sample_Name = case_when(
    Sample_Name == 'Mixture 4' ~ 'Mixture 13',
    
    Sample_Name == 'Mixture 5' ~ 'Mixture 14',
    TRUE ~ as.character(Sample_Name)
  ))


mixture_results <- res %>%
  select(Sample_Name:Endothelial) %>%
  pivot_longer(cols = -Sample_Name,
               names_to = 'component',
               values_to = 'predicted_percent') %>%
  mutate(component = str_to_lower(component),
         predicted_percent = predicted_percent*100) %>%
  full_join(mixtures_results, by = c('Sample_Name', 'component'))  %>%
  mutate(component = str_to_sentence(component))

# stats
stats <- mixture_results %>%
  filter(grepl('Mix', Sample_Name)) %>%
  nest(data = -component) %>%
  mutate(lm = map(data, ~lm(predicted_percent ~ actual_percent, .)),
         glanced = map(lm, glance)) %>%
  select(-data, -lm) %>%
  unnest(glanced) %>%
  mutate(label = paste0('R2=', signif(r.squared, digits = 2),
                        '\n', pvalue(p.value, add_p = TRUE)))


# scatter plots
mixture_results %>%
  filter(grepl('Mix', Sample_Name)) %>%
  ggplot() +
  geom_point(aes(x = actual_percent, y = predicted_percent, color = component)) +
  geom_smooth(aes(x = actual_percent, y = predicted_percent, color = component),
              method = 'lm', se = FALSE) +
  geom_label(data = stats, aes(label = label),
             x = 0, y = 80, hjust = 0) +
  scale_y_continuous(limits = c(0,100)) +
  facet_wrap(~component) +
  scale_color_manual(values = color_code_tissue[unique(mixture_results$component)], 
                         na.value = '#636363',
                         guide = 'none') 

# bar plots
mixture_results %>%
  filter(grepl('Mix', Sample_Name)) %>%
  mutate(Sample_Name = factor(Sample_Name, 
                              levels = paste0('Mixture ', c(1:3, 13, 14, 6:12)))) %>%
  pivot_longer(cols = contains('percent'),
               names_to = 'type',
               values_to = 'percent') %>%
  mutate(type = gsub('_.*', '', type)) %>%
  ggplot() +
  geom_bar(stat=  'identity',
           aes(x = Sample_Name, y = percent, fill = component)) +
  facet_wrap(ncol = 1, vars(type)) +
  labs(x = '') +
  scale_x_discrete(labels = function(x)gsub('Mixture ', '', x))

mixture_results %>%
  filter(grepl('Mix', Sample_Name)) %>%
  mutate(Sample_Name = factor(Sample_Name, 
                              levels = paste0('Mixture ', c(1:3, 13, 14, 6:12)))) %>%
  pivot_longer(cols = contains('percent'),
               names_to = 'type',
               values_to = 'percent') %>%
  mutate(type = gsub('_.*', '', type)) %>%
  ggplot() +
  geom_bar(stat=  'identity',
           aes(x = Sample_Name, y = percent, fill = component)) +
  facet_grid(rows = vars(type),
             cols = vars(case_id), scales = 'free', space = 'free') +
  labs(x = '') +
  theme(strip.background = element_blank()) +
  scale_x_discrete(labels = function(x)gsub('Mixture ', '', x))
             
```

# EPIDISH

```{r}
epidish_res1 <- epidish(
  beta.m = getBeta(mset_test)[rownames(coefs_third),pData(mset_test)$Trimester == 'Third'],
  ref.m = coefs_third,
  method = 'RPC')

epidish_res2 <- epidish(
  beta.m = getBeta(mset_test)[rownames(coefs_third),pData(mset_test)$Trimester == 'Third'],
  ref.m = coefs_third,
  method = 'CBS')

epidish_res3 <- epidish(
  beta.m = getBeta(mset_test)[rownames(coefs_third),pData(mset_test)$Trimester == 'Third'],
  ref.m = coefs_third,
  method = 'CP',
  constraint = 'inequality')

#first trime
epidish_res11 <- epidish(
  beta.m = getBeta(mset_test)[rownames(coefs_first),pData(mset_test)$Trimester == 'First'],
  ref.m = coefs_first,
  method = 'RPC')

epidish_res22 <- epidish(
  beta.m = getBeta(mset_test)[rownames(coefs_first),pData(mset_test)$Trimester == 'First'],
  ref.m = coefs_first,
  method = 'CBS')

epidish_res33 <- epidish(
  beta.m = getBeta(mset_test)[rownames(coefs_first),pData(mset_test)$Trimester == 'First'],
  ref.m = coefs_first,
  method = 'CP',
  constraint = 'inequality')

str(epidish_res1)

epidish_res1 <- epidish_res1$estF %>%
  as.data.frame() %>%
  bind_cols(Sample_Names = rownames(.), .) %>%
  pivot_longer(
    cols = -Sample_Names,
    names_to = 'component',
    values_to = 'percent'
  ) %>%
  mutate(algorithm = 'epidish (RPC)')

epidish_res2 <- epidish_res2$estF %>%
  as.data.frame() %>%
  bind_cols(Sample_Names = rownames(.), .) %>%
  pivot_longer(
    cols = -Sample_Names,
    names_to = 'component',
    values_to = 'percent'
  ) %>%
  mutate(algorithm = 'epidish (CBS)')

epidish_res3 <- epidish_res3$estF %>%
  as.data.frame() %>%
  bind_cols(Sample_Names = rownames(.), .) %>%
  pivot_longer(
    cols = -Sample_Names,
    names_to = 'component',
    values_to = 'percent'
  ) %>%
  mutate(algorithm = 'epidish (CP)')

epidish_res11 <- epidish_res11$estF %>%
  as.data.frame() %>%
  bind_cols(Sample_Names = rownames(.), .) %>%
  pivot_longer(
    cols = -Sample_Names,
    names_to = 'component',
    values_to = 'percent'
  ) %>%
  mutate(algorithm = 'epidish (RPC)')

epidish_res22 <- epidish_res22$estF %>%
  as.data.frame() %>%
  bind_cols(Sample_Names = rownames(.), .) %>%
  pivot_longer(
    cols = -Sample_Names,
    names_to = 'component',
    values_to = 'percent'
  ) %>%
  mutate(algorithm = 'epidish (CBS)')

epidish_res33 <- epidish_res33$estF %>%
  as.data.frame() %>%
  bind_cols(Sample_Names = rownames(.), .) %>%
  pivot_longer(
    cols = -Sample_Names,
    names_to = 'component',
    values_to = 'percent'
  ) %>%
  mutate(algorithm = 'epidish (CP)')

epidish_results <- bind_rows(epidish_res1, epidish_res2, epidish_res3, 
                             epidish_res11, epidish_res22, epidish_res33) %>%
   dplyr::rename(Sample_Name = Sample_Names) %>%
  mutate(percent = percent*100) %>%
  left_join(mixture_results %>% select(Sample_Name, case_id))

# combine epidish results with houseman
mixture_results_all <- mixture_results %>%
  pivot_longer(
    cols = contains('percent'),
    names_to = 'algorithm',
    values_to = 'percent'
  ) %>%
  mutate(algorithm = gsub('_percent', '', algorithm),
         algorithm = ifelse(algorithm == 'predicted', 'minfi (CP)', algorithm)) %>%
  select(-case_id) %>%
  bind_rows(epidish_results %>% select(-case_id)) %>%
  mutate(algorithm = factor(algorithm, 
                            levels = c('actual', 'epidish (RPC)', 'epidish (CBS)', 
                                       'epidish (CP)', 'minfi (CP)'))) %>%
  distinct()

# bar plot
mixture_results_all %>%
  filter(grepl('Mix', Sample_Name)) %>%
  mutate(Sample_Name = factor(Sample_Name, 
                              levels = paste0('Mixture ', c(1:3, 13, 14, 6:12)))) %>%
  ggplot() +
  geom_bar(stat=  'identity',
           aes(x = Sample_Name, y = percent, fill = component)) +
  facet_wrap(ncol = 1, vars(algorithm)) +
  labs(x = '', y= '') +
  theme(strip.background = element_blank())+
  scale_fill_manual(values = color_code_tissue[unique(mixture_results_all$component)],
                    na.value = '#636363') +
  scale_y_continuous(labels = function(x)paste0(x, '%'), expand = c(0,0))+
  scale_x_discrete(labels = function(x)gsub('Mixture ', '', x), expand = c(0,0))

# stats
stats <- mixture_results_all %>%
  filter(grepl('Mix', Sample_Name)) %>%
  pivot_wider(id_cols = c(Sample_Name, component),
              names_from = 'algorithm',
              values_from = 'percent') %>%
  pivot_longer(cols = -c(Sample_Name, component, actual),
               names_to = 'algorithm',
               values_to = 'predicted') %>%
  
  nest(data = -c(component, algorithm)) %>%
  mutate(lm = map(data, ~lm(predicted ~ actual, .)),
         glanced = map(lm, glance)) %>%
  select(-data, -lm) %>%
  unnest(glanced) %>%
  mutate(label = paste0('R2=', signif(r.squared, digits = 2),
                        '\n', pvalue(p.value, add_p = TRUE)))

mixture_results_all %>%
  filter(grepl('Mix', Sample_Name)) %>%
  pivot_wider(id_cols = c(Sample_Name, component),
              names_from = 'algorithm',
              values_from = 'percent') %>%
  pivot_longer(cols = -c(Sample_Name, component, actual),
               names_to = 'algorithm',
               values_to = 'predicted') %>%
  group_by(algorithm) %>%
  rmse(truth = actual, estimate = predicted)


stats %>%
  group_by(algorithm) %>%
  summarize(mean_r2 = mean(r.squared))

mixture_results_all %>%
  filter(grepl('Mix', Sample_Name)) %>%
  pivot_wider(id_cols = c(Sample_Name, component),
              names_from = 'algorithm',
              values_from = 'percent') %>%
  pivot_longer(cols = -c(Sample_Name, component, actual),
               names_to = 'algorithm',
               values_to = 'predicted')  %>%
  ggplot(aes(x = actual, y = predicted, color = component)) +
  geom_point() +
  geom_smooth(method = 'lm', se = FALSE) +
  geom_label(color = 'black', size = 3, data = stats, aes(label = label),
             x = 0, y = 100, hjust = 0, vjust = 1) +
  facet_grid(cols = vars(algorithm), rows = vars(component)) +
  theme(strip.background = element_blank(),
        panel.grid.minor = element_blank()) +
  scale_color_manual(values = color_code_tissue[unique(mixture_results_all$component)], 
                         na.value = '#636363',
                         guide = 'none') +
  scale_x_continuous(labels = function(x)paste0(x, '%'), breaks = c(0,30,60,100))+
  scale_y_continuous(limits = c(0,100),labels = function(x)paste0(x, '%')) +
  labs(x = 'Actual', y = 'Predicted')
  
```

# Heatmap of deconvolution probes

```{r}
probes_third %>% str
pheatmap(probes_third$coefEsts, cluster_cols = FALSE, cluster_rows = TRUE,
         show_rownames = FALSE) 
```

# FACS-determined proportions

So mixture data is potentially garbage. Here I look at the FACS cell proportions.

```{r}
facs_prop <- read_excel(here::here('data', 'main', 'raw', 'FACS_proportions.xlsx'))

# process
facs_prop <- facs_prop %>%
  as.matrix() %>%
  magrittr::set_rownames(.[,'Cell_type']) %>%
  t() %>%
  as.data.frame %>%
  bind_cols(Sample_Name = rownames(.), .) %>%
  dplyr::slice(-1) %>%
  select(Sample_Name, contains('% of live')) %>%
  pivot_longer(cols = -Sample_Name, names_to = 'component', values_to = 'value') %>%
  mutate(component = gsub(' \\(\\% of live\\)', '', component),
         percent = str_extract(value, '[0-9]?\\.?[0-9]+(?=\\%)') %>% as.numeric(),
         Case_ID = str_extract(Sample_Name, 'PM[0-9]+'),
         component = ifelse(component == 'Fibroblasts', 'Stromal', component)) %>%
  select(-value) %>% 
  
  # REMOVE samples
  filter(!grepl('TB Layer', Sample_Name),
         ) %>% 
  
  # average percentage
  group_by(Case_ID, component) %>%
  summarize(percent = mean(percent)) %>%
  
  # rescale such that sums to 1
  mutate(percent = percent*100 / sum(percent)) %>%
  group_by(Case_ID, component == 'Trophoblasts') %>%
  mutate(percent_constrained = percent*100/ sum(percent)) %>%
  ungroup() %>%
  mutate(percent_constrained = ifelse(percent_constrained == 100, NA,
                                      percent_constrained)) %>%
  select(-`component == "Trophoblasts"`) %>%
  
  pivot_longer(cols = contains('percent'),
               names_to = 'FACS',
               values_to = 'actual') %>%
  mutate(FACS = ifelse(FACS == 'percent', 'FACS',
                       ifelse(FACS == 'percent_constrained', 'FACS - constrained',
                              FACS)))



facs_results <-mixture_results_all %>%
  filter(!grepl('Mix', Sample_Name),
         algorithm != 'actual') %>%
  mutate(Case_ID = str_extract(Sample_Name, 'PM[0-9]+'))  %>%
  
  # constrain to non-troph pops
  filter(component != 'Trophoblasts') %>%
  group_by(Case_ID, algorithm) %>%
  mutate(percent = percent*100/sum(percent)) %>%
  inner_join(facs_prop, by = c('component', 'Case_ID'))
  
plot_scatter <- function(x){
  ggplot(data = x, aes(x = actual, y = percent, color =component)) +
  geom_point() +
  geom_smooth(method = 'lm', se = FALSE) +
  facet_grid(cols = vars(algorithm), rows = vars(component), scales = 'fixed') +
  theme(strip.background = element_blank(),
        panel.grid.minor = element_blank()) +
  scale_color_manual(values = color_code_tissue[unique(facs_results$component)], 
                         na.value = '#636363',
                         guide = 'none') +
  scale_x_continuous(labels = function(x)paste0(x, '%'))+
  scale_y_continuous(labels = function(x)paste0(x, '%')) +
  labs(x = 'Actual', y = 'Predicted') +
    coord_equal()
}

facs_results %>%
  filter(FACS == 'FACS',
         component == 'Endothelial')  %>%
  plot_scatter()
facs_results %>%
  filter(FACS == 'FACS',
         component == 'Hofbauer')  %>%
  plot_scatter()+
  scale_y_continuous(limits = c(0, 60), labels = function(x)paste0(x, '%')) 
facs_results %>%
  filter(FACS == 'FACS',
         component == 'Stromal')  %>%
  plot_scatter()



# stats
facs_stats <- facs_results %>%
  filter(FACS == 'FACS - constrained',
         component != 'Trophoblasts') %>%
  nest(data = -c(algorithm, component)) %>%
  mutate(lm = map(data, ~lm(percent ~ actual, .)),
         glanced = map(lm, glance)) %>%
  select(-data, -lm) %>%
  unnest(glanced) %>%
  mutate(label = paste0('R2=', signif(r.squared, digits = 2),
                        '\n', pvalue(p.value, add_p = TRUE)));facs_stats
facs_results %>%
  filter(FACS == 'FACS - constrained',
         component != 'Trophoblasts') %>%
  group_by(algorithm) %>%
  rmse(truth = actual, estimate = percent)

facs_results %>%
  filter(FACS == 'FACS - constrained',
         component != 'Trophoblasts') %>%
  ggplot(aes(x = actual, y = percent, color =component)) +
  geom_point() +
  geom_smooth(method = 'lm', se = FALSE) +  
  geom_label(data = facs_stats, 
             color = 'black', size = 3, 
             aes(label = label),
             x = 10, y = 120, hjust = 0, vjust = 1,
             alpha = 0) +

  facet_grid(cols = vars(algorithm), rows = vars(component), scales = 'fixed') +
  theme(strip.background = element_blank(),
        panel.grid.minor = element_blank()) +
  scale_color_manual(values = color_code_tissue[unique(facs_results$component)], 
                         na.value = '#636363',
                         guide = 'none') +
  scale_x_continuous(labels = function(x)paste0(x, '%'))+
  scale_y_continuous(limits = c(0, 120),labels = function(x)paste0(x, '%')) +
  labs(x = 'Actual', y = 'Predicted') + 
  coord_equal()


facs_stats %>%
  group_by(component, algorithm) %>%
  summarize(r2 = mean(r.squared)) %>%
  group_by(algorithm) %>%
  mutate(overall_r2 = mean(r2)) %>%
  ungroup() %>%
  arrange(algorithm, component)
```

# Villi

```{r}
# both first and third barplots
mixture_results_all %>%
  left_join(pDat_filt %>% select(Sample_Name, Tissue, Trimester)) %>%
  filter(algorithm != 'actual',
         Tissue == 'Villi')   %>%
  ggplot() +
  geom_bar(stat=  'identity',
           aes(x = Sample_Name, y = percent, fill = component)) +
  facet_grid(rows = vars(algorithm), cols = vars(Trimester), 
             scales = 'free', space = 'free') +
  labs(x = '') +
  theme(strip.background = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank()) +
  scale_fill_manual(values = color_code_tissue[unique(mixture_results_all$component)], 
                    na.value = '#636363') +
  scale_x_discrete(expand = c(0,0)) +
  scale_y_discrete(expand = c(0,1), limits = c(0,100))

# averaged
mixture_results_all %>%
  left_join(pDat_filt %>% select(Sample_Name, Tissue, Trimester)) %>%
  filter(algorithm != 'actual',
         Tissue == 'Villi')   %>%
  
  group_by(Trimester, algorithm, component) %>%
  summarize(percent = mean(percent)) %>%
  ggplot() +
  geom_bar(stat=  'identity',
           aes(x = Trimester, y = percent, fill = component)) +
  facet_grid(rows = vars(algorithm), scales = 'free', space = 'free') +
  labs(x = '') +
  theme(strip.background = element_blank(),
        axis.ticks.x = element_blank()) +
  scale_fill_manual(values = color_code_tissue[unique(mixture_results_all$component)], 
                    na.value = '#636363') +
  scale_x_discrete(expand = c(0,0)) +
  scale_y_discrete(expand = c(0,1), limits = c(0,100))

# between algorithms
mixture_results_all %>%
  left_join(pDat_filt %>% select(Sample_Name, Tissue, Trimester)) %>%
  filter(algorithm != 'actual',
         Tissue == 'Villi')   %>%
  ggplot() +
  geom_boxplot(aes(x = algorithm, y = percent, fill = component)) +
  facet_grid(cols = vars(component), rows = vars(Trimester), space = 'free') +
  labs(x = '', fill = '') +
  theme(strip.background = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) +
  scale_fill_manual(values = color_code_tissue[unique(mixture_results_all$component)], 
                    na.value = '#636363',
                    guide = 'none') +
  scale_x_discrete(labels = function(x)gsub('epidish', 'EpiDISH', x)) +
  scale_y_continuous(labels = function(x)paste0(x, '%'))



# first to third beeeswarm
mixture_results_all %>%
  left_join(pDat_filt %>% select(Sample_Name, Tissue, Trimester)) %>%
  filter(algorithm != 'actual',
         Tissue == 'Villi') %>%
  ggplot(aes(x = component, y = percent, color = Trimester)) +
  ggbeeswarm::geom_beeswarm(dodge.width = 0.75) +
  facet_grid(rows = vars(algorithm)) +
  theme(strip.background = element_blank(),
        panel.grid.minor = element_blank()) +
  scale_y_continuous(labels = function(x)paste0(x, '%'))
```

# Add nRBC to deconvolution

and apply to villi

```{r}
mset_filt
nrbc_noob <- readRDS(here::here(base_path, '2_14_nrbc_noob.rds'))

pData(mset_filt)$Study <- 'Yuan'

# combine nrbc to placenta data
mset_combined <- combineArrays(nrbc_noob, mset_filt)
mset_combined

pData(mset_combined) <- pData(mset_combined) %>% as.data.frame() %>%
  select(Sample_Name, Sex, Trimester, Tissue, Study) %>% 
  mutate(Tissue = gsub(' cs', '', Tissue),
         CellType = Tissue) %>% DataFrame()
  
pData(mset_combined) 
pDat_combined <- pData(mset_combined) %>%
  as_tibble() 
  
# subset to reference
mset_combined_ref <- mset_combined[,pData(mset_combined)$CellType %in% c('Trophoblasts', 'Stromal', 'Hofbauer', 'Endothelial', 'nRBC')]

# pick probes
probes_third_nrbc <- minfi:::pickCompProbes(
  mset_combined_ref[, pData(mset_combined_ref)$Trimester == 'Third'], 
  cellTypes = c('Trophoblasts', 'Stromal', 'Hofbauer', 'Endothelial', 'nRBC'),
  compositeCellType = 'Placenta',
  probeSelect = "both")

probes_first_nrbc <- minfi:::pickCompProbes(
  mset_combined_ref[, pData(mset_combined_ref)$Trimester == 'First' |
             pData(mset_combined_ref)$CellType == 'nRBC'], 
  cellTypes = c('Trophoblasts', 'Stromal', 'Hofbauer', 'Endothelial', 'nRBC'),
  compositeCellType = 'Placenta',
  probeSelect = "both")

# extract coefficients
coefs_combined_third <- probes_third_nrbc$coefEsts
coefs_combined_first <- probes_first_nrbc$coefEsts
```

## Heatmap

```{r}
pheatmap(coefs_combined_third, cluster_cols = FALSE, cluster_rows = TRUE,
         show_rownames = FALSE) 
```


## Generate in silico mixtures

For each cell type ("a"),
generate proportions randomly from 0-1.
cell type b proportion is drawn from 0-a
cell type c proportion is drawn from 0-(b+a)
cell type d is 1-(a+b+c)

These are the coefficients for generating mixtures with proportions uniformly distributed between 0-1 for cell type A. 

Apply this to generate mixtures for each cell type.


```{r}

#### generate in silico mixtures
# filter to coefficient probes
mset_combined_coefs <- 
  mset_combined[unique(c(rownames(coefs_combined_third), rownames(coefs_combined_first))),]

colnames(mset_combined_coefs) <- pData(mset_combined_coefs)$Sample_Name

getBeta(mset_combined_coefs) %>%
  as.data.frame() %>%
  bind_cols(cpg = rownames(.), .) %>%
  pivot_longer(cols = -cpg, names_to = 'Sample_Name', values_to = 'beta') %>%
  left_join(pDat_combined) %>%
  nest(data = c(cpg, beta))


# generate beta matrices
b_3_troph <- 
  getBeta(mset_combined_coefs)[,pData(mset_combined_coefs)$Trimester == 'Third' &
                                 pData(mset_combined_coefs)$CellType == 'Trophoblasts']
b_3_endo <- 
  getBeta(mset_combined_coefs)[,pData(mset_combined_coefs)$Trimester == 'Third' &
                                 pData(mset_combined_coefs)$CellType == 'Endothelial']
b_3_strom <- 
  getBeta(mset_combined_coefs)[,pData(mset_combined_coefs)$Trimester == 'Third' &
                                 pData(mset_combined_coefs)$CellType == 'Stromal']
b_3_hofb <- 
  getBeta(mset_combined_coefs)[,pData(mset_combined_coefs)$Trimester == 'Third' &
                                 pData(mset_combined_coefs)$CellType == 'Hofbauer']
b_3_nrbc <- 
  getBeta(mset_combined_coefs)[,pData(mset_combined_coefs)$Trimester == 'Third' &
                                 pData(mset_combined_coefs)$CellType == 'nRBC']

b_1_troph <- 
  getBeta(mset_combined_coefs)[,pData(mset_combined_coefs)$Trimester == 'Third' &
                                 pData(mset_combined_coefs)$CellType == 'Trophoblasts']
b_1_endo <- 
  getBeta(mset_combined_coefs)[,pData(mset_combined_coefs)$Trimester == 'Third' &
                                 pData(mset_combined_coefs)$CellType == 'Endothelial']
b_1_strom <- 
  getBeta(mset_combined_coefs)[,pData(mset_combined_coefs)$Trimester == 'Third' &
                                 pData(mset_combined_coefs)$CellType == 'Stromal']
b_1_hofb <- 
  getBeta(mset_combined_coefs)[,pData(mset_combined_coefs)$Trimester == 'Third' &
                                 pData(mset_combined_coefs)$CellType == 'Hofbauer']

# generate coefficients
n <- 250
a <- runif(n = n)
b <- runif(n = n, min = 0, max = 1-a)
c <- runif(n = n, min = 0, max = 1-(b + a))
d <- runif(n = n, min = 0, max = 1-(c + b + a))
e <- 1-(a+b+c+d)

all(a + b + c + d + e== 1)

props <- tibble(a = a, b=b, c=c, d=d, e=e)
props <- props %>%
  as.matrix() %>%
  rbind(., .[,c(2:5,1)], 
        .[,c(3:5,1:2)], 
        .[,c(4:5,1:3)], 
        .[,c(5,1:4)]) %>%
  as_tibble() %>%
  mutate(sample = 1:(n*5))

# generate mixtures
set.seed(1)
silico_mix <- props %>%
  group_by(sample) %>%
  mutate(mix3 = list(
           a*b_3_troph[,sample(1:ncol(b_3_troph),1)] + 
           b*b_3_strom[,sample(1:ncol(b_3_strom),1)] +
           c*b_3_endo[,sample(1:ncol(b_3_endo),1)] +
           d*b_3_hofb[,sample(1:ncol(b_3_hofb),1)] +
           e*b_3_nrbc[,sample(1:ncol(b_3_nrbc),1)]),
         mix1 = list(
           a*b_1_troph[,sample(1:ncol(b_1_troph),1)] + 
           b*b_1_strom[,sample(1:ncol(b_1_strom),1)] +
           c*b_1_endo[,sample(1:ncol(b_1_endo),1)] +
           d*b_1_hofb[,sample(1:ncol(b_1_hofb),1)] +
           e*b_3_nrbc[,sample(1:ncol(b_3_nrbc),1)]),
         
         cpg= list(rownames(mset_combined_coefs))) %>% ungroup()

silico_pDat <- silico_mix %>%
  select(a:sample) %>%
  mutate(mix3 = 'mix3', mix1 = 'mix1') %>%
   pivot_longer(cols = c(mix3, mix1),
                names_to = 'sample2',
                values_to = 'remove') %>%
  mutate(sample_name = paste0('sample', sample, '_', sample2),
         trimester = ifelse(grepl('mix3', sample_name), 'Third', 'First')) %>%
  select(-sample, -sample2, -remove) 
  

silico_data <- silico_mix %>%
  select(sample, mix3:cpg) %>%
  unnest(c(mix3, mix1, cpg)) %>%
  
  pivot_longer(cols = c(mix3, mix1),
               names_to = 'sample2',
               values_to = 'beta') %>%
  mutate(sample_name = paste0('sample', sample, '_', sample2)) %>%
  select(-sample, -sample2) %>%
  pivot_wider(id_cols = cpg, names_from = 'sample_name', values_from = 'beta' ) %>%
  as.data.frame() %>%
  magrittr::set_rownames(.$cpg) %>%
  select(-cpg) %>%
  as.matrix()
```

Check composition distribution

```{r}
silico_pDat %>%
  pivot_longer(cols = a:e,
               names_to = 'component',
               values_to = 'proportion') %>%
  mutate(component = case_when(
    component == 'a' ~ 'Trophoblasts',
    component == 'b' ~ 'Stromal',
    component == 'c' ~ 'Endothelial',
    component == 'd' ~ 'Hofbauer',
    component == 'e' ~ 'nRBC',
  )) %>% {
    ggplot(data =., aes(x = proportion, color = component)) +
  geom_density() +
  facet_grid(rows = vars(component), cols = vars(trimester))  +
  scale_color_manual(values = color_code_tissue[unique(.$component)], 
                    na.value = '#636363',
                    guide = 'none') 
    }

```


## apply to in silico mixtures


```{r}

# houseman
houseman_silico <- minfi:::projectCellType(
  silico_data[rownames(coefs_combined_third),], 
  coefs_combined_third,
  lessThanOne = FALSE) %>%
  as.data.frame() %>%
  mutate(Sample_Names = rownames(.), .) %>%
  as_tibble() %>%
  pivot_longer(cols = -Sample_Names,
               names_to = 'component',
               values_to = 'percent') %>%
  mutate(algorithm = 'Houseman (CP)')

epidish_res111 <- epidish(
  beta.m = silico_data,
  ref.m = coefs_combined_third,
  method = 'RPC')

epidish_res111 <- epidish_res111$estF %>%
  as.data.frame() %>%
  bind_cols(Sample_Names = rownames(.), .) %>%
  pivot_longer(
    cols = -Sample_Names,
    names_to = 'component',
    values_to = 'percent'
  ) %>%
  mutate(algorithm = 'epidish (RPC)')

epidish_res222 <- epidish(
  beta.m = silico_data,
  ref.m = coefs_combined_third,
  method = 'CBS')

epidish_res222 <- epidish_res222$estF %>%
  as.data.frame() %>%
  bind_cols(Sample_Names = rownames(.), .) %>%
  pivot_longer(
    cols = -Sample_Names,
    names_to = 'component',
    values_to = 'percent'
  ) %>%
  mutate(algorithm = 'epidish (CBS)')

epidish_res333 <- epidish(
  beta.m = silico_data,
  ref.m = coefs_combined_third,
  method = 'CP')

epidish_res333 <- epidish_res333$estF %>%
  as.data.frame() %>%
  bind_cols(Sample_Names = rownames(.), .) %>%
  pivot_longer(
    cols = -Sample_Names,
    names_to = 'component',
    values_to = 'percent'
  ) %>%
  mutate(algorithm = 'epidish (CP)')

#combine algorithms
epidish_results <- bind_rows(epidish_res111, epidish_res222, epidish_res333, 
                             houseman_silico) %>%
  dplyr::rename(sample_name = Sample_Names) %>%
  left_join(silico_pDat %>%
              pivot_longer(cols = a:e,
                           names_to ='component',
                           values_to = 'actual') %>%
              mutate(component = case_when(
                    component == 'a' ~ 'Trophoblasts',
                    component == 'b' ~ 'Stromal',
                    component == 'c' ~ 'Endothelial',
                    component == 'd' ~ 'Hofbauer',
                    component == 'e' ~ 'nRBC'))) %>%
  dplyr::rename(estimated = percent)

# stats
stats <- epidish_results %>%
  group_by(algorithm, component) %>%
  metrics(estimated, actual) %>%
  mutate(label = number(.estimate, accuracy = 0.01)) %>%
  pivot_wider(id_cols = c(algorithm, component),
              names_from = '.metric',
              values_from = c('label', '.estimate')) %>%
  rowwise() %>%
  mutate(label = paste0('RMSE=', label_rmse,
                        '\nR2=', label_rsq,
                        '\nMAE=', label_mae))

# scatter plot
epidish_results %>%
  filter(trimester == 'Third') %>%
  ggplot(aes(x = actual, y = estimated, color = component)) +
  geom_point(alpha = 0.2) +
  geom_text(data = stats, x= 0.05, y= 1, aes(label = label), color = 'black',
             hjust = 0, vjust = 1) +
  facet_grid(cols = vars(algorithm), rows = vars(component)) +
  scale_color_manual(values = color_code_tissue[unique(epidish_results$component)], 
                    na.value = '#636363',
                    guide = 'none') +
  scale_x_continuous(expand = c(0,0), labels = scales::percent) +
  scale_y_continuous(expand = c(0,0), labels = scales::percent) +
  theme(panel.grid = element_blank())

stats %>%
  group_by(algorithm) %>%
  summarize(rmse = mean(.estimate_rmse),
            rsq = mean(.estimate_rsq),
            mae = mean(.estimate_mae))


# mean difference
epidish_results <- epidish_results %>%
  mutate(deviation = estimated-actual)

epidish_results %>%
  filter(trimester == 'Third') %>%
  ggplot(aes(x = deviation, color = component)) +
  geom_density() +
  geom_vline(data = epidish_results %>%
               filter(trimester == 'Third') %>%
               group_by(algorithm, component) %>%
               summarize(mean_diff = mean(deviation)),
             aes(xintercept = mean_diff),
             linetype = 'dashed') +
  geom_text(data = epidish_results %>%
               filter(trimester == 'Third') %>%
               group_by(algorithm, component) %>%
               summarize(mean_diff = percent(mean(deviation), accuracy = 0.01)),
             aes(label = mean_diff),
            x = -0.05, y = 39, hjust = 0, vjust =1,color = 'black') +
  geom_vline(xintercept = 0) +
  facet_grid(cols = vars(algorithm), rows = vars(component)) +
  scale_color_manual(values = color_code_tissue[unique(epidish_results$component)], 
                    na.value = '#636363',
                    guide = 'none') +
  scale_x_continuous(limits = c(-0.05, 0.05), labels = percent) +
  scale_y_continuous(expand = c(0,0))+
  theme(panel.grid = element_blank(),
        strip.background = element_blank()) +
  labs(x = '(estimated percentage) - (actual)')
```

## apply to villi

```{r}
# apply deconvolution and process results
epidish_res111 <- epidish(
  beta.m = getBeta(mset_test)[rownames(coefs_combined_third)
                                ,pData(mset_test)$Trimester == 'Third'],
  ref.m = coefs_combined_third,
  method = 'RPC')

epidish_res1111 <- epidish(
  beta.m = getBeta(mset_test)[rownames(coefs_combined_first)
                                ,pData(mset_test)$Trimester == 'First'],
  ref.m = coefs_combined_first,
  method = 'RPC')

epidish_res111 <- epidish_res111$estF %>%
  as.data.frame() %>%
  bind_cols(Sample_Names = rownames(.), .) %>%
  pivot_longer(
    cols = -Sample_Names,
    names_to = 'component',
    values_to = 'percent'
  ) %>%
  mutate(algorithm = 'epidish (RPC)')

epidish_res1111 <- epidish_res1111$estF %>%
  as.data.frame() %>%
  bind_cols(Sample_Names = rownames(.), .) %>%
  pivot_longer(
    cols = -Sample_Names,
    names_to = 'component',
    values_to = 'percent'
  ) %>%
  mutate(algorithm = 'epidish (RPC)')

epidish_rpc <- bind_rows(epidish_res111, epidish_res1111) %>%
  dplyr::rename(Sample_Name = Sample_Names) %>%
  left_join(pDat_filt %>% select(Sample_Name, Sex, Trimester, Tissue, GA))  %>%
  distinct() 
```

### plots 

```{r}
# analyze
epidish_rpc %>%
  filter(Tissue == 'Villi') %>%
  pivot_wider(id_cols = -c(component, percent),
              names_from = 'component',
              values_from = 'percent') %>%
  mutate(Sample_Name = fct_reorder2(Sample_Name, Trophoblasts, Stromal)) %>%
  pivot_longer(cols = Trophoblasts:nRBC,
               names_to = 'component',
               values_to = 'percent') %>%
  ggplot(aes(x = Sample_Name, y = percent, fill = component)) +
  geom_bar(stat = 'identity') +
  scale_fill_manual(values = color_code_tissue[unique(epidish_rpc$component)], 
                    na.value = '#636363') +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        panel.border= element_blank(),
        strip.background = element_blank(),
        strip.text = element_text(hjust =0)) +
  scale_y_continuous(expand = c(0,0), labels = percent) +
  labs(x = '', y = '', fill = '') +
  facet_grid(cols = vars(Trimester), scales = 'free', space = 'free') +
  geom_text(aes(label = number(GA)), y = 0.1)

epidish_rpc %>%
  filter(Tissue == 'Villi') %>%
  ggplot(aes(x = component, y = percent, color = component)) +
  geom_boxplot() +
  geom_jitter() +
  scale_color_manual(values = color_code_tissue[unique(epidish_rpc$component)], 
                    na.value = '#636363', guide = 'none') +
  scale_y_continuous(labels = percent) +
  theme(panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(),
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        strip.background = element_blank(),
        strip.text = element_text(hjust = 0)) +
  facet_grid(cols = vars(Trimester)) +
  labs(x = '', color = '', y = '') 

epidish_rpc %>%
  filter(Tissue == 'Villi') %>%
  group_by(Trimester, component) %>%
  summarize(mean = mean(percent))
```

### Stats n stuff

```{r}
# between trimester
epidish_rpc %>%
  filter(Tissue == 'Villi') %>%
  nest(data = -component) %>%
  mutate(lm = map(data, ~lm(percent ~ Trimester, .)),
         glanced = map(lm, glance)) %>%
  select(-data, -lm)  %>%
  unnest(cols = c(glanced)) %>%
  select(component, r.squared, p.value) %>%
  mutate(adj_p = p.adjust(p.value, method = 'bonferroni'),
         p_value = pvalue(adj_p))

# between sex
stats_by_sex <- epidish_rpc %>%
  filter(Tissue == 'Villi') %>%
  filter(Trimester == 'Third', component != 'nRBC') %>%
  nest(data = -component) %>%
  mutate(lm = map(data, ~lm(percent ~ Sex, .)),
         glanced = map(lm, glance)) %>%
  select(-data, -lm)  %>%
  unnest(cols = c(glanced)) %>%
  select(component, r.squared, p.value) %>%
  mutate(adj_p = p.adjust(p.value, method = 'bonferroni'),
         p_value = pvalue(adj_p),
         testing_variable = 'Sex');stats_by_sex
  
epidish_rpc %>%
  filter(Tissue == 'Villi') %>%
  filter(Trimester == 'Third', component !='nRBC') %>%
  ggplot(aes(x = component, y = percent, color = Sex)) +
  geom_beeswarm(dodge.width = 0.75, cex = 1.5) +
  #geom_jitter(position = position_jitterdodge(dodge.width = 0.75)) +
  scale_y_continuous(labels = function(x)percent(x,accuracy = 1)) +
  scale_color_manual(values = c('#af8dc3', '#7fbf7b')) +
  theme(panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(),
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        strip.background = element_blank(),
        strip.text = element_text(hjust = 0)) +
  labs(x = '', color = '', y = '') 

epidish_rpc %>%
  filter(Tissue == 'Villi') %>%
  filter(Trimester == 'Third') %>%
  select(Sample_Name, Sex) %>%
  distinct() %>%
  dplyr::count(Sex)

# between ancestry
epidish_rpc  %>%
  filter(Tissue == 'Villi') %>%
  filter(Trimester == 'Third') %>%
  left_join(ancestry) %>%
  ggplot(aes(x = PC1_geno, y = PC2_geno, color = Predicted_ethnicity)) +
  geom_point()

epidish_rpc %>%
  left_join(ancestry) %>%
  filter(Tissue == 'Villi') %>%
  filter(Trimester == 'Third', Predicted_ethnicity != 'Ambiguous', component != 'nRBC') %>%
  ggplot(aes(x = component, y = percent, color = Predicted_ethnicity)) +
  geom_beeswarm(dodge.width = 0.75,size = 0.9) +
  #geom_boxplot() +
  #geom_jitter(position = position_jitterdodge(dodge.width = 0.75)) +
  scale_y_continuous(labels = percent) +
  scale_color_manual(values = c('#d8b365', '#5ab4ac')) +
  theme(panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        axis.line = element_line(),
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
        strip.background = element_blank(),
        strip.text = element_text(hjust = 0)) +
  labs(x = '', color = '', y = '')  

stats_by_ancestry <- epidish_rpc %>%
  left_join(ancestry) %>%
  filter(Tissue == 'Villi') %>%
  filter(Trimester == 'Third', Predicted_ethnicity != 'Ambiguous', component != 'nRBC') %>%
  nest(data = -component) %>%
  mutate(lm = map(data, ~lm(percent ~ Predicted_ethnicity, .)),
         glanced = map(lm, glance)) %>%
  select(-data, -lm)  %>%
  unnest(cols = c(glanced)) %>%
  select(component, r.squared, p.value) %>%
  mutate(adj_p = p.adjust(p.value, method = 'bonferroni'),
         p_value = pvalue(adj_p),
         testing_variable = 'ancestry'); stats_by_ancestry

epidish_rpc %>%
  left_join(ancestry) %>%
  filter(Tissue == 'Villi') %>%
  select(Sample_Name, Predicted_ethnicity) %>%
  distinct() %>%
  dplyr::count(Predicted_ethnicity)


```

# estimate GA

We want to find any association with gestational age and cell composition.

Here I predict Ga using planet

```{r}
?pl_infer_age()


ga <- tibble(Sample_Name = colnames(mset_test),
  ga_rpc = pl_infer_age(getBeta(mset_test), 'RPC'),
  ga_cpc = pl_infer_age(getBeta(mset_test), 'CPC'),
  ga_rrpc = pl_infer_age(getBeta(mset_test), 'RRPC')
)

# join ga to pDat
pDat_filt <- pDat_filt %>%
  left_join(ga)

# join deconv estimates to pDat
pDat_filt <- pDat_filt %>%
  left_join(
    by = c('Sample_Name' = 'sample_name'),
    epidish_rpc %>%
      pivot_wider(id_cols = Sample_Name,
                  names_from = c('algorithm', 'component'),
                  values_from = 'percent') %>%
      clean_names() 
  )

pDat_ga_comp <- pDat_filt %>% 
  filter(Trimester == 'First', Tissue == 'Villi') %>%
  select(Sample_Name, Trimester, Tissue, contains('ga'), contains('epidish')) %>%
  pivot_longer(cols = contains('epidish'),
               names_to = 'component',
               names_prefix = 'epidish_rpc_',
               values_to = 'proportion') %>%
  pivot_longer(cols = contains('ga'),
               names_to = 'ga',
               names_prefix = 'ga_',
               values_to = 'weeks') %>%
  mutate(ga = ifelse(ga == 'GA', 'reported', ga) %>%
           as.factor() %>%
           fct_relevel(levels = c('reported')))

stats_by_ga <- pDat_ga_comp %>%
  filter(component != 'n_rbc',
         ga %in% c('reported', 'rpc')) %>%
  nest(data = -c(component, ga)) %>%
  mutate(lm = map(data, ~lm(proportion ~ weeks, .)),
         glanced = map(lm, glance)) %>%
  select(-data, -lm)  %>%
  unnest(cols = c(glanced)) %>%
  select(component, ga, r.squared, p.value) %>%
  mutate(adj_p = p.adjust(p.value, method = 'fdr'),
         p_value = pvalue(p.value, 0.01) %>%
           ifelse(. < 0.05, 'p<0.05', .),
         component = str_to_sentence(component) ); stats_by_ga

pDat_ga_comp %>% 
  filter(component != 'n_rbc',
         ga %in% c('reported', 'rpc')) %>%
  mutate(component = str_to_sentence(component)) %>%
  {
    ggplot(data = ., aes(x = weeks, y = proportion, color = component)) +
      geom_point() +
      geom_smooth(method = 'lm', se = FALSE,alpha = 0.5) +
      facet_grid(cols = vars(ga), rows = vars(component), scales = 'free_y') +
      scale_y_continuous(labels = percent) +  
      scale_color_manual(values = color_code_tissue[unique(.$component)], 
                       na.value = '#636363',
                       guide = 'none')  +
      theme(panel.grid = element_blank())
  }
  
```

# Save

Join to pDat_filt and save

```{r eval = F}

epidish_rpc %>%
  pivot_wider(id_cols = Sample_Name,
              names_from = c('algorithm', 'component'),
              values_from = 'percent') %>%
  clean_names() %>%
  right_join(pDat_filt, by = c('sample_name'= 'Sample_Name')) %>%
  saveRDS(here(base_path, '2_14_pDat_filt.rds'))

```

```{r eval = F}
# 3rd and 1st trimester reference cpgs
coefs_combined_third %>%
  as.data.frame() %>%
  bind_cols(cpg = rownames(.), .) %>%
  write_csv( na = 'NA',
             path = here('outs', '2_14_deconvolution_reference_cpgs_third.csv'))

coefs_combined_first %>%
  as.data.frame() %>%
  bind_cols(cpg = rownames(.), .) %>%
  write_csv(na = 'NA',
            path = here('outs', '2_14_deconvolution_reference_cpgs_first.csv'))

# save deconvolution (nrbc included) estimates on villi
epidish_rpc %>%
  left_join(ancestry) %>%
  saveRDS(here(base_path, '2_14_deconvolution_results.rds'))

# save statistical testing
bind_rows(stats_by_sex, stats_by_ancestry) %>%
  write_csv(na = '', path = here('outs', '2_14_stats_by_sex_ancestry.csv'))

# in silico stuff
epidish_results %>%
  saveRDS(here(base_path, '2_14_in_silico_deconvolution_results.rds'))
stats %>%
  write_csv(here('outs', '2_14_in_silico_deconvolution_stats.csv'))
```

