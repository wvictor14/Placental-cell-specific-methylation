---
title: "22_Term"
author: "Victor Yuan"
date: "31/05/2019"
output:
  html_document:
    keep_md: true
    toc: true
    toc_depth: 4
    toc_float:
      collapsed: false
    theme: spacelab
editor_options: 
  chunk_output_type: console
---

This is part 2 of the term analysis.

In part 1, 21_Term.Rmd, I found a contaminated hofbauer sample that I removed. Here I reproduce
some of plots without that sample, and continue with linear modelling analysis.

# Setup

## Load libraries and data

```{r message = F, warning = F}
# libraries and data
library(ggplot2)
library(tidyverse)
library(ggrepel)
library(viridis)
library(scales)
library(RColorBrewer)
library(pheatmap)
library(irlba)
library(yahew)
library(GGally)
library(cowplot)
library(umap)
library(dendextend)
library(stringr)
```

## Data

Here I call 'syncytiotrophoblasts' into 'Trophoblasts enz' and add 'cs' suffixes to the cell sorted
samples.

```{r}
# pdata
pDat_term  <- readRDS('../../data/main/interim/16_pDat.rds')
pDat_term <- pDat_term %>% 
  mutate(Tissue = case_when(
    Tissue %in% c('Endothelial', 'Hofbauer', 'Stromal', 'Trophoblasts') ~ paste(Tissue, 'cs'),
    Tissue == 'Syncytiotrophoblast' ~ 'Trophoblasts enz',
    TRUE ~ Tissue
  )) %>%
  
  # REMOVE CONTAMINED HOFBAUER SAMPLES
  filter(Sample_Name != 'PM364_hofb_cs')

# methylation data
betas <- readRDS('../../data/main/interim/14_betas_noob_filt.rds')
betas_term <- betas[,pDat_term$Sentrix]
colnames(betas_term) <- pDat_term$Sample_Name

probe_anno <- readRDS('../../data/main/interim/11_probe_anno.rds')

# snp data
snp_betas <- readRDS('../../data/main/interim/11_snp_betas.rds')

# annotation
zhou_anno <- readRDS('Z:/Victor/Data/DNAm annotations/zhou2017_EPIC.hg19.manifest.rds') 

# color key
color_code <- readRDS('../../data/main/interim/11_color_code.rds')
color_code[[1]] <- color_code[[1]]  %>%
  mutate(Tissue = case_when(
    Tissue %in% c('Endothelial', 'Hofbauer', 'Stromal', 'Trophoblasts', 
                  'Dead Cells and Lymphocytes') ~ paste(Tissue, 'cs'),
    Tissue == 'Syncytiotrophoblast' ~ 'Trophoblasts enz',
    TRUE ~ Tissue
  ))
color_code_tissue <- setNames(color_code[[1]]$Colors_Tissue, color_code[[1]]$Tissue)
```

# 1.0 Global methylation

## Density distributions

Here we plot the density distributions of the betas across each tissue

```{r}
# pull out sample names for each tissue
list <- list()
for (i in unique(pDat_term$Tissue)) {
  list[[i]] <- pDat_term %>% filter(Tissue == i) %>% pull(Sample_Name)
}

# for each tissue estimate the density
densities <- tibble(Tissue = names(list),
       betas = lapply(list, function(x) as.vector(betas_term[,x]))) %>%
  mutate(densities = map(betas, ~ density(.))) %>%
  
   # pull out x and y coordinates
  mutate(x = map(densities, 'x'),
         y = map(densities, 'y')) %>%

  # remove input data, and unnest
  select(-betas, -densities) %>%
  unnest()

# plot
ggplot(densities, 
       aes(x = x, y = y, color = Tissue)) +
  geom_line(size = 2, alpha = 0.5) + theme_bw() +
  scale_x_continuous(breaks = c(0, 0.25, 0.5, 0.75, 1)) +#facet_wrap(~Tissue) +
  scale_color_manual(values= color_code_tissue[unique(pDat_term$Tissue)])
```

Density for each sample:

```{r}
sample_densities <- pDat_term %>%
  select(Sample_Name, Tissue) %>%
  mutate(densities = apply(betas_term, 2, density)) %>%
  mutate(x = map(densities, 'x'),
         y = map(densities, 'y')) %>%
  select(-densities) %>%
  unnest()

ggplot(sample_densities, aes(x = x, y = y, color = Tissue, group = Sample_Name)) +
  geom_line(size = 1, alpha = 0.5) + theme_bw() +
  scale_x_continuous(breaks = c(0, 0.25, 0.5, 0.75, 1))  +
  facet_wrap(~Tissue) +
  scale_color_manual(values = color_code_tissue[unique(pDat_term$Tissue)]) +
  geom_text_repel(data = sample_densities %>% 
                    filter(Sample_Name == 'PM364_hofb_cs', x > 0.55, x < 0.6) %>%
                    dplyr::slice(1),
                  aes(x = x, y = y, label = Sample_Name), inherit.aes = F,
                  nudge_y = 1, nudge_x = -0.1) +
  labs(x = '% methylation', y = 'density')
```

TODO:: Apply mixture modelling to determine hyper, hypomethylated, and hemi-methylated CpGs. Compare
number of CpGs falling to each distribution. 3 component mixture: 2 beta distributions and one 
uniform

## PCA

```{r}
# compute pca
set.seed(1)
pca <- prcomp_irlba(t(betas_term), n = 20, center = T, scale = F)

# add pc scores to pdata
pca_scores <- pca$x[,1:20] %>% as.data.frame()
colnames(pca_scores) <- paste0(colnames(pca_scores), '_processed')
pDat_term <- pDat_term %>% 
  select(-contains('processed')) %>%
  bind_cols(pca_scores)

# create proportion variance explained data frame
pc_info <- summary(pca)$importance %>% 
  as.data.frame() %>% 
  tibble::rownames_to_column(var = 'variable') %>%
  gather(key = 'PC', value = 'value', -variable) %>%
  as_tibble() %>%
  mutate(PC = factor(as.character(PC), levels = paste0('PC', 1:20)),
         Label = ifelse(variable == 'Proportion of Variance',
                        paste0(PC, ' (', prettyNum(value*100, digits = 2), '%)'),
                        as.character(PC))) %>%
  arrange(variable, PC)

  
# correlate PCs with phenodata
pc_cor <- lmmatrix(dep = pca$x[,1:20],
                   ind = pDat_term %>%
                   dplyr::select(Case_ID, Tissue, Sex, Predicted_ethnicity_nothresh,#bio
                                 Prob_African, Prob_Asian, Prob_Caucasian,
                                 Week, Chip_number, Row_numeric, Row_factor, Batch_BSC, # batch
                                 DNA_loaded, 
                                 failed_probes,
                                 cor_to_reference, Prob_SNP_outlier),
                   metric = 'Pvalue')
# plot data
pc_cor <- pc_cor %>% as.data.frame() %>% 
  
  # add dep variables
  mutate(dep = rownames(pc_cor)) %>%
  
  # reshape
  gather(PC, pval, -dep) %>%
  
  # pvalue categories
  mutate(pval_cat = factor(case_when(
    pval > 0.05  ~ '> 0.05',
    pval < 0.05 & pval > 0.01 ~ '< 0.05',
    pval < 0.01 & pval > 0.001 ~ '< 0.01',
    pval < 0.001 ~ '< 0.001'
  ), levels = c('> 0.05', '< 0.05','< 0.01', '< 0.001')),
  
  # make PC is encoded with proper levels!!!
  PC = factor(PC, levels = paste0('PC', 1:20))) %>% as_tibble()

# create color palette
colpal <- c('white', '#fee8c8', '#fdbb84', '#e34a33')
names(colpal) <- levels(pc_cor$pval_cat)

# relevel
pc_cor <- pc_cor %>% 
  mutate(dep = factor(dep, levels = c('Case_ID', 'Tissue', 'Sex', 'Predicted_ethnicity_nothresh',#bio
                                     'Prob_African', 'Prob_Asian', 'Prob_Caucasian',
                                     'Week', 'Chip_number', 'Row_numeric', 'Row_factor', 
                                     'Batch_BSC', # batch
                                     'DNA_loaded',
                                     'failed_probes',
                                     'cor_to_reference', 'Prob_SNP_outlier')))
                                     
p1 <- ggplot(pc_cor, aes(x = PC, y = dep, fill = pval_cat)) +
  geom_tile(col = 'lightgrey') + theme_bw() +
  scale_x_discrete(expand = c(0, 0), labels = 1:20) +
  scale_y_discrete(expand = c(0, 0)) +
  scale_fill_manual(values = colpal)  + 
  labs(y = '', fill = 'P value')

p2 <- ggplot(pc_info %>% filter(variable == 'Proportion of Variance') %>%
               mutate(value = value*100), 
             aes(x = PC, y = value)) +
  geom_bar(stat = 'identity') +
  theme_bw() + 
  scale_x_discrete(expand = c(0, 0), labels = 1:20) + 
  scale_y_continuous(expand = c(0, 0)) +
  labs(y = '% variance explained')

egg::ggarrange(p1, p2, heights = c(3,1))
```

Scatterplots

```{r}
ggplot(pDat_term, aes(x = PC1_processed, y = Prob_SNP_outlier)) +
  geom_point() +
  geom_text_repel(data = pDat_term %>% filter(Prob_SNP_outlier > 0.3 | 
                                              Sample_Name == 'PM374_endo_cs'),
                  aes(x = PC1_processed, y = Prob_SNP_outlier, label = Sample_Name)) 

ggplot(pDat_term, aes(x = PC1_processed, y = cor_to_reference)) +
  geom_point() +
  geom_text_repel(data = pDat_term %>% filter(cor_to_reference < 0.96),
                  aes(x = PC1_processed, y = cor_to_reference, label = Sample_Name))
```
